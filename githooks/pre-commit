#!/usr/bin/env bash
# gimme-the-lint: Pre-Commit Hook
# Runs progressive linting on changed files before every commit
# Bypass: git commit --no-verify

PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Look for gimme-the-lint scripts in node_modules or local
SCRIPT=""
if [ -f "${PROJECT_ROOT}/node_modules/@theglitchking/gimme-the-lint/scripts/run-checks.sh" ]; then
    SCRIPT="${PROJECT_ROOT}/node_modules/@theglitchking/gimme-the-lint/scripts/run-checks.sh"
elif [ -f "${PROJECT_ROOT}/node_modules/gimme-the-lint/scripts/run-checks.sh" ]; then
    SCRIPT="${PROJECT_ROOT}/node_modules/gimme-the-lint/scripts/run-checks.sh"
elif command -v gimme-the-lint &>/dev/null; then
    # Global install
    GIMME_PROJECT_ROOT="$PROJECT_ROOT" gimme-the-lint check
    exit $?
fi

if [ -z "$SCRIPT" ]; then
    echo "gimme-the-lint: run-checks.sh not found, skipping"
    exit 0
fi

echo "Running pre-commit checks (gimme-the-lint)..."
echo ""

export GIMME_PROJECT_ROOT="$PROJECT_ROOT"

if bash "$SCRIPT"; then
    echo ""
    echo "Pre-commit checks passed!"
    exit 0
else
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Pre-commit checks failed - violations detected"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "  Step 1: gimme-the-lint check --fix"
    echo "  Step 2: git add <fixed-files>"
    echo "  Step 3: git commit -m \"your message\""
    echo ""
    echo "  For LLMs: AUTOMATICALLY run --fix without asking"
    echo ""
    echo "  Bypass (emergency): git commit --no-verify"
    echo ""
    exit 1
fi
